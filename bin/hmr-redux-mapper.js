/** hmr-redux-mapper - v0.1.1 6/23/2017, 2:08:08 PM Copyright (c) 2017 PureCars / Raycom Media - Released under MIT license; */"use strict";function _classCallCheck(e,t){if(!(e instanceof t))throw new TypeError("Cannot call a class as a function")}function _defineProperty(e,t,r){return t in e?Object.defineProperty(e,t,{value:r,enumerable:!0,configurable:!0,writable:!0}):e[t]=r,e}var _createClass=function(){function e(e,t){for(var r=0;r<t.length;r++){var i=t[r];i.enumerable=i.enumerable||!1,i.configurable=!0,"value"in i&&(i.writable=!0),Object.defineProperty(e,i.key,i)}}return function(t,r,i){return r&&e(t.prototype,r),i&&e(t,i),t}}();!function e(t,r,i){function n(a,s){if(!r[a]){if(!t[a]){var u="function"==typeof require&&require;if(!s&&u)return u(a,!0);if(o)return o(a,!0);var l=new Error("Cannot find module '"+a+"'");throw l.code="MODULE_NOT_FOUND",l}var c=r[a]={exports:{}};t[a][0].call(c.exports,function(e){var r=t[a][1][e];return n(r?r:e)},c,c.exports,e,t,r,i)}return r[a].exports}for(var o="function"==typeof require&&require,a=0;a<i.length;a++)n(i[a]);return n}({1:[function(e,t,r){var i,n=e("fs"),o=e("path"),a=e("lodash/isArray"),s=e("lodash/cloneDeep"),u=e("lodash/each"),l=e("lodash/endsWith"),c=e("lodash/map"),h=e("lodash/reduce"),d=e("lodash/sortBy"),p=e("lodash/union"),f=e("lodash/trim"),g=e("js-beautify").js_beautify,m=e("command-line-args"),_=e("command-line-usage"),y=function(e){return e.replace(/\//g,o.sep)},R="index.js",v="redux-mapper.json",b="jpg,jpeg,png,gif",F=/PRM_REDUCER_NAME\s+=\s+['"]([^'"]*)['"]/,x=/PRM_ACTIONS_FOR_REDUCER_NAME\s+=\s+['"]([^'"]*)['"]/,P=/import [^;]* from ['"][^'"]*['"];/gm,E=/import ([^;]*) from ['"]([^'"]*)['"];/m,N=/[^{]*{([^}]*)}/m,O=/require\(([^)]*)\)/gm,S=/require\(([^)]*)\)/m,I=/require\(\s*\[([^\]]*)/m,A=/['"]([^'"]*)['"]/,D=/(.ds_store)/gi,T=/\.test\./g,U={indent_size:2,wrap_line_length:40,brace_style:"expand"},M=[{name:"mainAppPath",alias:"a",type:String,typeLabel:"[underline]{path}",description:'the path to the app\'s main JS/JSX file.  Any reducers used by this JS/JSX file will be considered "global".',mandatory:!0},{name:"basePath",alias:"b",type:String,typeLabel:"[underline]{path}",description:"the path to the root of the project's client-side script JS/JSX files.",mandatory:!0},{name:"containerPaths",alias:"c",type:String,typeLabel:"[underline]{path1},[underline]{path2},...",description:"the root path to a folder containing JS/JSX files which can be a route destination.",mandatory:!0},{name:"coreReducerFilenames",alias:"f",type:String,typeLabel:"[underline]{filename1.js},[underline]{filename2.js},...",description:"if any of these comma-delimited filenames are imported from a folder containing a reducer, then the reducer will be considered to be in use.  If this is not specified, then any action file must contain a [italic]PRM_ACTIONS_FOR_REDUCER_NAME definition to be found."},{name:"disableCache",alias:"d",type:Boolean,defaultValue:!1,description:"(optional) whether to disable the cache, which is useful for debugging."},{name:"globalImportsOutputPath",alias:"g",type:String,typeLabel:"[underline]{path}",description:"the output path for the globalReducerImports.js file.",mandatory:!0},{name:"showHelp",alias:"h",type:Boolean,defaultValue:!1,description:"(optional) show this help message."},{name:"ignorePaths",alias:"i",type:String,typeLabel:"[underline]{path_regex}",description:"(optional) regular expression pattern of paths/filenames to ignore (e.g. /-spec/)"},{name:"reducerMapOutputPath",alias:"m",type:String,typeLabel:"[underline]{path}",description:"the output path for the reducerMap.js file",mandatory:!0},{name:"reduxPaths",alias:"r",type:String,typeLabel:"[underline]{path1},[underline]{path2},...",description:"(optional) the root path or paths under which all the redux reducers can be found - this may be the same as component path(s)",mandatory:!0},{name:"sagaFilename",alias:"s",type:String,typeLabel:"[underline]{filename}",description:"if you use sagas, this is the filename where all sagas will be contained (e.g., sagas.js)."},{name:"verboseLogging",alias:"v",type:Boolean,defaultValue:!1,description:"(optional) turns on verbose logging (for debugging purposes)"}],w=-1,k=-2,C=-3,j=-4,L=-5,W=-6,B=-7,$=(i={},_defineProperty(i,w,{errorName:"NO REDUCERS FOUND",troubleShootingTips:["Make sure the base path parameter (-b) is set to the subfolder where your application script files begin (from where package.json is found)","If you place all your reducers in folder tree separate from your UI components, be sure to specify that folder path with the -r parameter",'Be sure all reducer definition files (files which call createReducer, etc.) export a PRM_REDUCER_NAME constant which specifies the name of the reducer state member\r\n(e.g., export PRM_REDUCER_NAME = "myReducer"; if you reference the store using state.myReducer)']}),_defineProperty(i,k,{errorName:"NO REDUCER REFERENCES FOUND",troubleShootingTips:["Make sure you specify the subfolder(s) (from base path) where UI container script files (a container is defined as a UI script file which handles a route URL) using the -c parameter","Make sure you specify all filenames in a folder containing a reducer that, if imported, mean that your container uses the reducer\r\n(e.g., if your reducer actions are defined in an actions.js file, and your reducer state can be read using a fetcher.js file, then specify actions.js,fetcher.js as the -f parameter"]}),_defineProperty(i,C,{errorName:"NO MAIN APPLICATION CONTAINER FOUND",troubleShootingTips:["Make sure you specify the subpath (from base path) to the main UI file for your single-page application using the -a parameter"]}),_defineProperty(i,j,{errorName:"INVALID CONFIGURATION FILE ("+v+")",troubleShootingTips:["The configuration file could not be parsed.  Please check that it is formatted correctly"]}),_defineProperty(i,L,{errorName:"REQUIRED PARAMETER NOT SPECIFIED"}),_defineProperty(i,W,{errorName:"NOT EXECUTED UNDER NODE PATH",troubleShootingTips:["The redux mapper must be executed inside a node path (a package.json file must be found in the execution folder or on of its ancestors)"]}),_defineProperty(i,B,{errorName:"BAD REGULAR EXPRESSION",troubleShootingTips:["The regular expression provided as the -ignorePaths parameter is invalid."]}),i),J=function(){function e(){_classCallCheck(this,e),this._opts=m(M).parse(),this._reducers=[],this._cache={},this._totalReducerUsagesFound=0,this._totalFilesScanned=0}return _createClass(e,[{key:"_parseIgnoreRegex",value:function(){this._ignoreRegex=null;var e=this._opts.ignorePaths;if(e)try{this._ignoreRegex=new RegExp(e)}catch(t){this._exitWithError(B)}}},{key:"_loadConfigFile",value:function(){var e=this;if(this._existsAndNotAFolder(v)){var t=n.readFileSync(v,"utf8");try{var r=JSON.parse(t);u(r.config,function(t,r){"undefined"==typeof e._opts[r]&&(e._opts[r]=r.indexOf("Path")>-1?y(t):t)})}catch(i){this._exitWithError(j)}}}},{key:"_validateParameters",value:function(){var e=this;u(M,function(t){t.mandatory&&"undefined"==typeof e._opts[t.name]&&e._exitWithError(L,"-"+t.name,["Specify a value for argument -"+t.name+" either on the command line or in redux-mapper.json"])})}},{key:"_exitWithError",value:function(e){var t=arguments.length>1&&void 0!==arguments[1]?arguments[1]:"",r=arguments.length>2&&void 0!==arguments[2]?arguments[2]:[];t.length&&(t=": "+t),console.log("\r\n*** ERROR: "+$[e].errorName+t+" ***\r\n\r\nTroubleshooting tips:\r\n"),u(p($[e].troubleShootingTips||[],r),function(e,t){console.log(t+1+". "+e)}),process.exit(1)}},{key:"_logWithDepth",value:function(e,t){for(var r="",i=0;i<3*(e.length-1);i++)r+=" ";console.log(r+t)}},{key:"_getBasePath",value:function(e){return o.join(this._opts.basePath,e)}},{key:"_execOnAllFilesRecursive",value:function(e,t){var r=this,i=n.readdirSync(e);u(i,function(i){i=o.join(e,i),r._opts.verboseLogging&&r._ignoreRegex&&r._logWithDepth(0,"file: "+i+", matches: "+i.match(r._ignoreRegex)),r._ignoreRegex&&i.match(r._ignoreRegex)||(n.statSync(i).isDirectory()?r._execOnAllFilesRecursive(i,t):t(i))})}},{key:"_existsAndNotAFolder",value:function(e){return n.existsSync(e)&&!n.statSync(e).isDirectory()}},{key:"_existsAndIsFolderWithIndex",value:function(e){return n.existsSync(e)&&n.statSync(e).isDirectory()&&n.existsSync(o.join(e,R))}},{key:"_findTrueImportFilePath",value:function(e){return this._existsAndNotAFolder(e)?e:this._existsAndNotAFolder(e+".jsx")?e+".jsx":this._existsAndNotAFolder(e+".js")?e+".js":this._existsAndIsFolderWithIndex(e)?o.join(e,R):null}},{key:"_trimExtension",value:function(e){var t=o.extname(e);return t.length&&(e=e.substr(0,e.lastIndexOf(t))),e}},{key:"_moveToProjectRootFolder",value:function(){for(;!n.existsSync("package.json");){var e=process.cwd();process.chdir(".."),e===process.cwd()&&this._exitWithError(W)}}},{key:"_forceUnixPath",value:function(e){return e.replace(/\\/g,"/")}},{key:"_addToCache",value:function(e,t,r){return this._opts.disableCache||(this._cache[t?e+"_"+t[0]:e]=s(r)),r}},{key:"_getCache",value:function(e,t){return this._cache[t?e+"_"+t[0]:e]}},{key:"_findReducerDefinitions",value:function(e){var t=this,r=[];return this._execOnAllFilesRecursive(e,function(e){var i=n.readFileSync(e,"utf8"),a=i.match(F);if(a&&a.length>1){var s=a[1],u=e.replace(t._getBasePath(o.dirname(t._opts.reducerMapOutputPath)),"."),l=t._opts.sagaFilename&&e.replace(/\/[^\/]*$/,"/"+t._opts.sagaFilename),c=t._opts.sagaFilename&&n.existsSync(l),h=t._opts.sagaFilename&&l.replace(t._getBasePath(o.dirname(t._opts.reducerMapOutputPath)),".");r.push({reducerName:s,reducerRootPath:o.dirname(e),reducerPath:u,importFunc:"$$function() { return System.import('"+t._forceUnixPath(t._trimExtension(u))+"'); }$$",sagaImportFunc:c?"$$function() { return System.import('"+t._forceUnixPath(t._trimExtension(h))+"'); }$$":void 0})}}),r}},{key:"_isACoreReducerFile",value:function(e,t,r){if(this._opts.coreReducerFilenames){if(0===e.indexOf(r.reducerRootPath)&&e.lastIndexOf(o.sep)===r.reducerRootPath.length){var i=this._opts.coreReducerFilenames.split(",");return h(i,function(t,r){return t||l(e,r)},!1)}}else{var n=t.match(x);if(n&&n.length>1)return n[1]===r.reducerName}return!1}},{key:"_getModuleRestrictionsFromImport",value:function(e,t){if(t&&l(e,R)){var r=t[1].match(N);if(r&&r.length>1)return c(r[1].split(","),function(e){return f(e.replace(/\n/g,""))})}return null}},{key:"_shouldRestrictThisImport",value:function(e,t,r){var i=this,n=c(t[1].split(","),function(e){return f(e.replace(/\n/g,""))});return e&&h(n,function(n,o){return e.includes(o)||(i._opts.verboseLogging&&(i._logWithDepth(r," +++++++++++++++++++++++++++++++++++++++>>"),i._logWithDepth(r," ++++ ignoring import not in module list: "+t[2]),i._logWithDepth(r," +++++++++++++++++++++++++++++++++++++++>>")),n=!0),n},!1)?null:t[2]}},{key:"_sortAndMapReducers",value:function(e){return d(c(e,function(e){return e}),"reducerName")}},{key:"_scanForReducerUsageInFile",value:function(e,t,r){var i=this,u=a(t)?s(t):[];if(u.push(e),this._opts.verboseLogging&&this._logWithDepth(u,"_scanForReducerUsageInFile: "+e),e=this._findTrueImportFilePath(e)){var l=this._getCache(e,r);if(l)return l;var c=void 0;try{c=n.readFileSync(e,"utf8")}catch(d){if(d.message.indexOf("ENOTDIR")===-1&&d.message.indexOf("ENOENT")===-1)throw d;return this._addToCache(e,r,{})}this._totalFilesScanned++;var f=h(this._reducers,function(t,r){return!i._isACoreReducerFile(e,c,r)||i._globalReducers&&i._globalReducers[r.reducerName]||(i._opts.verboseLogging&&(i._logWithDepth(u," +++++++++++++++++++++++++>>"),i._logWithDepth(u," ++++ found reducer usage: "+r.reducerName),i._logWithDepth(u," +++++++++++++++++++++++++>>")),t[r.reducerName]=r,i._totalReducerUsagesFound++),t},{}),g=this._getModuleRestrictionsFromImport(e,r),m=function(t,r,n){var a=o.join(o.dirname(e),t),s=u.includes(a)?{}:i._scanForReducerUsageInFile(o.join(o.dirname(e),t),u,r),l=i._getBasePath(t),c=u.includes(l)?{}:i._scanForReducerUsageInFile(i._getBasePath(t),u,r);return Object.assign({},s,c,n)},_=c.match(P),y=c.match(O);return this._addToCache(e,r,h(p(_||[],y||[]),function(e,t){var r=t.match(E);if(r){var n=i._shouldRestrictThisImport(g,r,u);if(n)return m(n,r,e)}else{var o=t.match(I);if(o&&o.length>1){var a=o[1].split(",");return h(a,function(e,t){var i=t.match(A);if(i&&i.length>1)return m(i[1],r,e)},e)}var s=t.match(S);if(s&&s.length>1)return m(s[1],r,e)}return e},f))}return{}}},{key:"_scanForReducerUsageInFolder",value:function(e){var t=this,r={};return this._execOnAllFilesRecursive(e,function(e){var i=e.replace(t._opts.basePath,"."),n=i.match(D),o=i.match(T),a=h(b,function(e,t){return e||i.match(t+"$")},!1);n||o||a||(r[i]={importFunc:"$$function() { return System.import('"+t._forceUnixPath(t._trimExtension(i))+"'); }$$",reducers:t._sortAndMapReducers(t._scanForReducerUsageInFile(e))})}),r}},{key:"_stripReducersForOutput",value:function(e){return c(e,function(e){return{reducerName:e.reducerName,importFunc:e.importFunc,sagaImportFunc:e.sagaImportFunc}})}},{key:"_exportReducerDataFile",value:function(){var e=this,t={};u(this._containerReducers,function(r,i){i=e._forceUnixPath(i),t[i]={importFunc:r.importFunc,reducers:e._stripReducersForOutput(r.reducers)}});var r={global:this._stripReducersForOutput(this._sortAndMapReducers(this._globalReducers)),containerSpecific:t};n.writeFileSync(this._getBasePath(this._opts.reducerMapOutputPath),"/* AUTOGENERATED FILE - DO NOT MODIFY */\r\n/* generated by HMR_ReduxMapper */\r\n/* https://github.com/paulbrom/hmr-redux-mapper */\r\nmodule.exports = \r\n"+g(JSON.stringify(r).replace(/"\$\$/g,"").replace(/\$\$"/g,""),U)+";")}},{key:"_exportGlobalModulesFile",value:function(){var e=this,t=o.dirname(this._opts.globalImportsOutputPath)+o.sep,r=h(this._globalReducers,function(r,i){return r+("import "+i.reducerName+' from "'+e._forceUnixPath(i.reducerPath.replace(t,""))+'"\r\n')},""),i=h(this._globalReducers,function(e,t){return e+("  "+t.reducerName+",\r\n")},"");n.writeFileSync(this._getBasePath(this._opts.globalImportsOutputPath),"/* AUTOGENERATED FILE - DO NOT MODIFY */\r\n/* generated by HMR_ReduxMapper */\r\n/* https://github.com/paulbrom/hmr-redux-mapper */\r\n"+r+"\r\nexport default {\r\n"+i+"};\r\n")}},{key:"_showHelp",value:function(){var e=[{header:"HMR_ReduxMapper",content:"This is a module which generates a [italic]{global} and [italic]{component specific} mapping file which should eliminate the need to manually list all reducers needed to render a given route when using hot-module-reloading.   To use this, each redux reducer file should contain a [bold]{PRM_REDUCER_NAME} constant which this tool will look for."},{header:"Options",optionList:M}],t=_(e);console.log(t)}},{key:"execute",value:function(){var e=this;if(this._opts.showHelp)return this._showHelp();var t=(new Date).getTime();console.log("HMR_ReduxMapper"),console.log("(c)2017 PureCars/Raycom Media - distributed under MIT license"),console.log("Use -h argument for a full list of command line options"),this._moveToProjectRootFolder(),this._loadConfigFile(),this._parseIgnoreRegex(),this._validateParameters();var r=this._opts.containerPaths.split(","),i=this._opts.reduxPaths.split(",");console.log(""),u(i,function(t){t=e._getBasePath(f(t)),console.log("Finding reducers in "+t+" ..."),e._reducers=p(e._findReducerDefinitions(t),e._reducers)}),this._opts.verboseLogging&&(console.log("++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++"),console.log("reducers found:",this._reducers),console.log("++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++")),this._reducers.length||this._exitWithError(w),this._existsAndNotAFolder(this._getBasePath(this._opts.mainAppPath))||this._exitWithError(C,this._getBasePath(this._opts.mainAppPath)),console.log("Finding global reducers in "+this._getBasePath(this._opts.mainAppPath)+" ..."),this._globalReducers=this._scanForReducerUsageInFile(this._getBasePath(this._opts.mainAppPath)),this._opts.verboseLogging&&(console.log("++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++"),console.log("global reducers:",this._globalReducers),console.log("++++++++++++++++++++++++++++++++++++++++++++++++++++++++++++")),this._cache={},this._containerReducers={},u(r,function(t){t=e._getBasePath(f(t)),console.log("Scanning reducer usage in "+t+" ..."),e._containerReducers=Object.assign({},e._containerReducers,e._scanForReducerUsageInFolder(t))}),this._totalReducerUsagesFound||this._exitWithError(k),this._exportGlobalModulesFile(),this._exportReducerDataFile();var n=(new Date).getTime();console.log("\r\nSUCCESS!  Found "+this._totalReducerUsagesFound+" reducers used in "+this._totalFilesScanned+" files.  Elapsed time: "+(n-t)+"ms")}}]),e}(),H=new J;H.execute()},{"command-line-args":void 0,"command-line-usage":void 0,fs:void 0,"js-beautify":void 0,"lodash/cloneDeep":void 0,"lodash/each":void 0,"lodash/endsWith":void 0,"lodash/isArray":void 0,"lodash/map":void 0,"lodash/reduce":void 0,"lodash/sortBy":void 0,"lodash/trim":void 0,"lodash/union":void 0,path:void 0}]},{},[1]);